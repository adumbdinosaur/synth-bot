{% extends "base.html" %}

{% block title %}Dashboard - Restricted View{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if message %}
    <div class="alert alert-{{ 'success' if message_type == 'success' else 'info' if message_type == 'info' else 'danger' }} alert-dismissible fade show"
        role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <div
                class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-tachometer-alt text-primary me-2"></i>
                    Dashboard - Session Active
                </h1>
            </div>
        </div>
    </div>

    <!-- Session Active Warning -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Neural Interface Active
                </h4>
                <p>
                    You currently have an active Neural Interface session running. While your interface is active,
                    access to energy regulation, behavior filters, autocorrect, and other configuration options is
                    restricted
                    for security and stability reasons.
                </p>
                <hr>
                <p class="mb-0">
                    <strong>To access full dashboard features:</strong> Please disconnect your Neural Interface session
                    using
                    the button below.
                </p>
            </div>
        </div>
    </div>

    <!-- Current Status - Read Only -->
    <div class="row">
        <div class="col-md-6">
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-battery-half me-2"></i>
                        Current Energy Level
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-4 fw-bold">{{ energy_level }}/{{ max_energy }}</span>
                        <span class="badge bg-primary fs-6">Energy Points</span>
                    </div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                            style="width: {{ (energy_level / max_energy * 100) if max_energy > 0 else 0 }}%"
                            aria-valuenow="{{ energy_level }}" aria-valuemin="0" aria-valuemax="{{ max_energy }}">
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Energy regenerates at {{ recharge_rate }} point{{ 's' if recharge_rate != 1 else '' }} per
                        minute
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-warning mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Session Management
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Your Neural Interface session is currently active and connected.
                        Disconnect to access full dashboard functionality.
                    </p>
                    <div class="d-grid gap-2">
                        <form method="post" action="/disconnect-session"
                            onsubmit="return confirm('Are you sure you want to disconnect your Neural Interface session? This will stop all automated activities.');">
                            <button type="submit" class="btn btn-danger btn-lg w-100">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                Disconnect Neural Interface
                            </button>
                        </form>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-warning me-1"></i>
                        This will stop all automated Telegram activities for your account.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activities
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshActivities()" id="refresh-btn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body" id="activities-container">
                    {% if recent_activities %}
                    <ul class="recent-activities-list">
                        {% for activity in recent_activities %}
                        <li>{{ activity.description }}</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="activity-placeholder">
                        <i class="fas fa-info-circle me-2"></i>
                        No recent activities found. Start using your Telegram account to see activity here.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Information Cards -->
    <div class="row">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Restricted Access Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-danger">Currently Unavailable:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-times text-danger me-2"></i>Energy settings modification</li>
                                <li><i class="fas fa-times text-danger me-2"></i>Badwords management</li>
                                <li><i class="fas fa-times text-danger me-2"></i>Autocorrect settings</li>
                                <li><i class="fas fa-times text-danger me-2"></i>Profile protection settings</li>
                                <li><i class="fas fa-times text-danger me-2"></i>Public dashboard access</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-success">Available:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>View current energy level</li>
                                <li><i class="fas fa-check text-success me-2"></i>View recharge rate</li>
                                <li><i class="fas fa-check text-success me-2"></i>View recent activities</li>
                                <li><i class="fas fa-check text-success me-2"></i>Session management</li>
                                <li><i class="fas fa-check text-success me-2"></i>Account information</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-refresh activities every 20 seconds
    let refreshInterval;

    function refreshActivities() {
        const refreshBtn = document.getElementById('refresh-btn');
        const container = document.getElementById('activities-container');

        // Show loading state
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
            refreshBtn.disabled = true;
        }
        container.innerHTML = '<div class="activity-loading">Loading recent activities...</div>';

        fetch('/api/recent-activity')
            .then(response => response.json())
            .then(data => {
                if (data.activities && Array.isArray(data.activities)) {
                    let html = '';
                    if (data.activities.length > 0) {
                        html = '<ul class="recent-activities-list">';
                        data.activities.forEach(activity => {
                            html += `<li>${activity.description}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html = `
                        <div class="activity-placeholder">
                            <i class="fas fa-info-circle me-2"></i>
                            No recent activities found. Start using your Telegram account to see activity here.
                        </div>`;
                    }
                    container.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error refreshing activities:', error);
                container.innerHTML = `
                <div class="activity-placeholder" style="color: var(--cyber-red);">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading activities. Please try again.
                </div>`;
            })
            .finally(() => {
                // Reset button state
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh';
                    refreshBtn.disabled = false;
                }
            });
    }

    // Start auto-refresh when page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Refresh every 20 seconds
        refreshInterval = setInterval(refreshActivities, 20000);
    });

    // Clean up interval when page unloads
    window.addEventListener('beforeunload', function () {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}