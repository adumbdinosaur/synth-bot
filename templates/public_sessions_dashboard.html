{% extends "base.html" %}

{% block title %}Public Sessions Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-broadcast-tower"></i> Public Sessions Dashboard</h2>
                <div class="text-muted">
                    <small>{{ total_sessions }} total session{{ 's' if total_sessions != 1 else '' }}, {{
                        connected_sessions }} currently connected</small>
                </div>
            </div>

            {% if error %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> {{ error }}
            </div>
            {% endif %}

            {% if not sessions %}
            <div class="text-center py-5">
                <i class="fas fa-satellite-dish fa-3x text-muted mb-3"></i>
                <h4>No Active Sessions</h4>
                <p class="text-muted">No users have active Telegram sessions at the moment.</p>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Public Sessions View:</strong> This dashboard shows all users with active Telegram sessions.
                Real-time connection status is displayed for each session.
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-2x text-primary mb-2"></i>
                            <h4 class="mb-0">{{ total_sessions }}</h4>
                            <small class="text-muted">Total Sessions</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-wifi fa-2x text-success mb-2"></i>
                            <h4 class="mb-0">{{ connected_sessions }}</h4>
                            <small class="text-muted">Connected Now</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h4 class="mb-0">{{ total_sessions - connected_sessions }}</h4>
                            <small class="text-muted">Offline Sessions</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <i class="fas fa-battery-half fa-2x text-info mb-2"></i>
                            <h4 class="mb-0">
                                {% set avg_energy = (sessions | sum(attribute='energy')) / sessions | length if sessions
                                else 0 %}
                                {{ "%.0f" | format(avg_energy) }}%
                            </h4>
                            <small class="text-muted">Avg Energy</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sessions Grid -->
            <div class="row">
                {% for session in sessions %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div
                        class="card h-100 {% if session.is_connected %}border-success{% else %}border-secondary{% endif %}">
                        <div
                            class="card-header {% if session.is_connected %}bg-success{% else %}bg-secondary{% endif %} text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-user"></i> {{ session.display_name }}
                            </h5>
                            <div class="d-flex align-items-center">
                                {% if session.is_connected %}
                                <span class="badge bg-light text-success me-2">
                                    <i class="fas fa-circle"></i> Online
                                </span>
                                {% else %}
                                <span class="badge bg-light text-secondary me-2">
                                    <i class="fas fa-circle"></i> Offline
                                </span>
                                {% endif %}
                                <small class="text-light">ID: {{ session.user_id }}</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Energy Level -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Energy Level</small>
                                    <small class="fw-bold">{{ session.energy }}/100</small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar 
                                            {% if session.energy > 70 %}bg-success
                                            {% elif session.energy > 30 %}bg-warning
                                            {% else %}bg-danger{% endif %}" role="progressbar"
                                        style="width: {{ session.energy }}%">
                                    </div>
                                </div>
                            </div>

                            <!-- Session Details -->
                            <div class="row g-2 mb-3">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-battery-half"></i> Recharge Rate:
                                        <span class="fw-bold">{{ session.energy_recharge_rate }}/minute</span>
                                    </small>
                                </div>
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-alt"></i> Member Since:
                                        <span class="fw-bold">{{ session.account_created[:7] if session.account_created
                                            else 'Unknown' }}</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Session Status -->
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted">Session Data</small><br>
                                        {% if session.has_session_data %}
                                        <i class="fas fa-check text-success"></i>
                                        <small class="text-success">Available</small>
                                        {% else %}
                                        <i class="fas fa-times text-danger"></i>
                                        <small class="text-danger">Missing</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted">Connection</small><br>
                                        {% if session.is_connected %}
                                        <i class="fas fa-wifi text-success"></i>
                                        <small class="text-success">Active</small>
                                        {% else %}
                                        <i class="fas fa-times text-warning"></i>
                                        <small class="text-warning">Inactive</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Timestamps -->
                            <div class="mt-3 pt-3 border-top">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-plus"></i> Account Created:
                                            <span class="fw-bold">{{ session.account_created[:10] if
                                                session.account_created else 'Unknown' }}</span>
                                        </small>
                                    </div>
                                    {% if session.session_last_updated %}
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> Session Updated:
                                            <span class="fw-bold">{{ session.session_last_updated[:16] if
                                                session.session_last_updated else 'Never' }}</span>
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <div class="d-grid">
                                <a href="/public/sessions/{{ session.user_id }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-info-circle"></i> View Details & Energy Settings
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Information Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-info-circle"></i> About Public Sessions Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <p>This dashboard provides a real-time view of all active Telegram sessions in the system.
                            </p>

                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-eye"></i> What You Can See:</h6>
                                    <ul class="small">
                                        <li>All users with Telegram sessions</li>
                                        <li>Real-time connection status</li>
                                        <li>Current energy levels</li>
                                        <li>Session data availability</li>
                                        <li>Basic account information</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-shield-alt"></i> Privacy Protection:</h6>
                                    <ul class="small">
                                        <li>Email addresses are not displayed</li>
                                        <li>Phone numbers are not displayed</li>
                                        <li>No personal messages are shown</li>
                                        <li>Only public session info is displayed</li>
                                        <li>This is read-only information</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-traffic-light"></i> Status Indicators:</h6>
                                    <ul class="small">
                                        <li><span class="badge bg-success">Online</span> - Currently connected and
                                            active</li>
                                        <li><span class="badge bg-secondary">Offline</span> - Session exists but not
                                            connected</li>
                                        <li><span class="badge bg-danger">Missing</span> - No session data available
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-battery-half"></i> Energy System:</h6>
                                    <ul class="small">
                                        <li>Energy recharges automatically over time</li>
                                        <li>Different users have different recharge rates</li>
                                        <li>Energy is consumed when performing actions</li>
                                        <li>Low energy may limit functionality</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-refresh every 30 seconds to show real-time status
    setTimeout(function () {
        window.location.reload();
    }, 30000);
</script>
{% endblock %}