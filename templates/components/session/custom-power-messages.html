<!-- Custom Power Messages Management Section Component -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card collapsible-section">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#powerMessagesCollapse"
                aria-expanded="false" aria-controls="powerMessagesCollapse">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4><i class="fas fa-battery-empty"></i> Custom Power Messages</h4>
                        <p class="text-muted mb-0">Create personalized messages that appear when your power is empty</p>
                    </div>
                    <i class="fas fa-chevron-down collapse-toggle collapsed"></i>
                </div>
            </div>
            <div class="collapse" id="powerMessagesCollapse">
                <div class="card-body">
                    <!-- Add New Power Message Form -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="fas fa-plus"></i> Add New Power Message</h5>
                            <form method="POST" action="/public/sessions/{{ session.user_id }}/power-messages/add">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="message" class="form-label">Power Message</label>
                                        <textarea class="form-control" id="message" name="message" rows="3"
                                            placeholder="*enters a dramatic low-power state with flickering LEDs*"
                                            required maxlength="500"></textarea>
                                        <div class="form-text">
                                            Create a roleplay message that describes what happens when you're out of
                                            power.
                                            Use asterisks (*) for action descriptions.
                                        </div>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-plus"></i> Add Message
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Current Power Messages List -->
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="fas fa-list"></i> Your Custom Power Messages
                                <span class="badge bg-primary">{{ custom_power_messages|length if custom_power_messages
                                    else 0 }}</span>
                            </h5>
                            {% if custom_power_messages %}
                            <div class="row">
                                {% for message in custom_power_messages %}
                                <div class="col-lg-6 mb-3">
                                    <div class="card h-100 {% if not message.is_active %}opacity-50{% endif %}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="flex-grow-1">
                                                    <p class="card-text mb-2">
                                                        <em>{{ message.message }}</em>
                                                    </p>
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock"></i>
                                                        Added: {{ message.created_at[:10] if message.created_at else
                                                        'Unknown' }}
                                                    </small>
                                                </div>
                                                <div class="badge-container">
                                                    {% if message.is_active %}
                                                    <span class="badge bg-success mb-2">
                                                        <i class="fas fa-check"></i> Active
                                                    </span>
                                                    {% else %}
                                                    <span class="badge bg-secondary mb-2">
                                                        <i class="fas fa-pause"></i> Inactive
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Message Actions -->
                                            <div class="btn-group w-100" role="group">
                                                <!-- Toggle Active/Inactive -->
                                                <form method="POST"
                                                    action="/public/sessions/{{ session.user_id }}/power-messages/toggle"
                                                    class="flex-fill">
                                                    <input type="hidden" name="message_id" value="{{ message.id }}">
                                                    <input type="hidden" name="is_active"
                                                        value="{{ 'false' if message.is_active else 'true' }}">
                                                    <button type="submit" class="btn btn-outline-warning btn-sm w-100">
                                                        <i
                                                            class="fas fa-{{ 'pause' if message.is_active else 'play' }}"></i>
                                                        {{ 'Deactivate' if message.is_active else 'Activate' }}
                                                    </button>
                                                </form>

                                                <!-- Edit Message -->
                                                <button type="button" class="btn btn-outline-primary btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editMessageModal{{ message.id }}">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>

                                                <!-- Delete Message -->
                                                <form method="POST"
                                                    action="/public/sessions/{{ session.user_id }}/power-messages/delete"
                                                    class="flex-fill">
                                                    <input type="hidden" name="message_id" value="{{ message.id }}">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100"
                                                        onclick="return confirm('Delete this power message?')">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div> <!-- Statistics -->
                            {% if custom_power_message_count %}
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-chart-bar"></i>
                                        <strong>Statistics:</strong>
                                        {{ custom_power_message_count.total }} total messages,
                                        {{ custom_power_message_count.active }} active,
                                        {{ custom_power_message_count.inactive }} inactive
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                No custom power messages created yet. Add one above to personalize your low-energy
                                experience!
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    {% if custom_power_messages %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bulk-actions-card">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fas fa-layer-group"></i> Bulk Actions
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <form method="POST"
                                                action="/public/sessions/{{ session.user_id }}/power-messages/activate-all"
                                                class="d-inline">
                                                <button type="submit" class="btn btn-outline-success w-100">
                                                    <i class="fas fa-play"></i> Activate All Messages
                                                </button>
                                            </form>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-outline-danger w-100"
                                                onclick="clearAllPowerMessages()">
                                                <i class="fas fa-trash-alt"></i> Clear All Messages
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Power Messages Info -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-primary">
                                <h6><i class="fas fa-info-circle"></i> How Custom Power Messages Work</h6>
                                <ul class="mb-0">
                                    <li><strong>Personalization:</strong> When your energy reaches zero, one of your
                                        active custom messages will be randomly selected</li>
                                    <li><strong>Fallback:</strong> If you have no active custom messages, the system
                                        uses default robotic messages</li>
                                    <li><strong>Toggle:</strong> You can activate/deactivate individual messages without
                                        deleting them</li>
                                    <li><strong>Roleplay Style:</strong> Use asterisks (*) to create immersive action
                                        descriptions</li>
                                    <li><strong>Character Limit:</strong> Keep messages under 500 characters for best
                                        results</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Message Modals (placed outside the main card structure) -->
{% if custom_power_messages %}
{% for message in custom_power_messages %}
<div class="modal fade" id="editMessageModal{{ message.id }}" tabindex="-1"
    aria-labelledby="editMessageModalLabel{{ message.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMessageModalLabel{{ message.id }}">Edit Power Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="/public/sessions/{{ session.user_id }}/power-messages/update">
                <div class="modal-body">
                    <input type="hidden" name="message_id" value="{{ message.id }}">
                    <div class="mb-3">
                        <label for="editMessage{{ message.id }}" class="form-label">Power Message</label>
                        <textarea class="form-control" id="editMessage{{ message.id }}" name="message" rows="4" required
                            maxlength="500" style="resize: vertical;">{{ message.message }}</textarea>
                        <div class="form-text">
                            Keep messages under 500 characters for best results.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

<script>
    function clearAllPowerMessages() {
        if (confirm('Are you sure you want to delete ALL custom power messages? This action cannot be undone.')) {
            fetch('/public/api/sessions/{{ session.user_id }}/power-messages/clear-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showAlert(data.message, 'success');
                        // Remove all power message cards
                        const messageCards = document.querySelectorAll('#powerMessagesCollapse .col-lg-6');
                        messageCards.forEach(card => card.remove());

                        // Update the badge count
                        const countBadge = document.querySelector('#powerMessagesCollapse .badge');
                        if (countBadge) {
                            countBadge.textContent = '0';
                        }

                        // Show the "no messages" alert
                        const messagesList = document.querySelector('#powerMessagesCollapse .row');
                        if (messagesList) {
                            messagesList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                No custom power messages created yet. Add one above to personalize your low-energy experience!
                            </div>
                        </div>
                    `;
                        }

                        // Hide bulk actions section
                        const bulkActions = document.querySelector('.bulk-actions-card');
                        if (bulkActions) {
                            bulkActions.parentElement.parentElement.style.display = 'none';
                        }

                        // Hide statistics section
                        const statistics = document.querySelector('#powerMessagesCollapse .alert-info');
                        if (statistics && statistics.innerHTML.includes('Statistics:')) {
                            statistics.parentElement.parentElement.style.display = 'none';
                        }
                    } else {
                        showAlert(data.error || 'Failed to clear messages. Please try again.', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Failed to clear messages. Please try again.', 'danger');
                });
        }
    }

    // Function to show alerts (this should be available in the main JavaScript)
    function showAlert(message, type) {
        // Check if the main showAlert function exists, otherwise create a simple alert
        if (typeof window.showAlert === 'function') {
            window.showAlert(message, type);
        } else {
            alert(message);
        }
    }

    // Function to update message card after toggle
    function updateMessageCard(messageId, isActive) {
        const card = document.querySelector(`[data-bs-target="#editMessageModal${messageId}"]`).closest('.col-lg-6');
        const cardElement = card.querySelector('.card');
        const badge = card.querySelector('.badge');
        const toggleButton = card.querySelector('form[action*="/toggle"] button');
        const toggleInput = card.querySelector('form[action*="/toggle"] input[name="is_active"]');

        if (isActive) {
            cardElement.classList.remove('opacity-50');
            badge.className = 'badge bg-success mb-2';
            badge.innerHTML = '<i class="fas fa-check"></i> Active';
            toggleButton.innerHTML = '<i class="fas fa-pause"></i> Deactivate';
            toggleInput.value = 'false';
        } else {
            cardElement.classList.add('opacity-50');
            badge.className = 'badge bg-secondary mb-2';
            badge.innerHTML = '<i class="fas fa-pause"></i> Inactive';
            toggleButton.innerHTML = '<i class="fas fa-play"></i> Activate';
            toggleInput.value = 'true';
        }
    }

    // Function to remove message card after deletion
    function removeMessageCard(messageId) {
        const card = document.querySelector(`[data-bs-target="#editMessageModal${messageId}"]`).closest('.col-lg-6');
        if (card) {
            card.remove();

            // Update count badge
            const countBadge = document.querySelector('#powerMessagesCollapse .badge');
            if (countBadge) {
                const currentCount = parseInt(countBadge.textContent) || 0;
                countBadge.textContent = Math.max(0, currentCount - 1);

                // If no messages left, show empty state
                if (currentCount - 1 === 0) {
                    const messagesList = document.querySelector('#powerMessagesCollapse .row');
                    if (messagesList) {
                        messagesList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                No custom power messages created yet. Add one above to personalize your low-energy experience!
                            </div>
                        </div>
                    `;
                    }

                    // Hide bulk actions
                    const bulkActions = document.querySelector('.bulk-actions-card');
                    if (bulkActions) {
                        bulkActions.parentElement.parentElement.style.display = 'none';
                    }
                }
            }
        }

        // Remove the modal too
        const modal = document.querySelector(`#editMessageModal${messageId}`);
        if (modal) {
            modal.remove();
        }
    }

    // Function to update message card after edit
    function updateMessageText(messageId, newMessage) {
        const card = document.querySelector(`[data-bs-target="#editMessageModal${messageId}"]`).closest('.col-lg-6');
        const messageText = card.querySelector('.card-text em');
        if (messageText) {
            messageText.textContent = newMessage;
        }

        // Also update the textarea in the modal
        const textarea = document.querySelector(`#editMessage${messageId}`);
        if (textarea) {
            textarea.value = newMessage;
        }
    }

    // Override the updateUIAfterFormSubmission function for power messages
    document.addEventListener('DOMContentLoaded', function () {
        // Store the original function
        const originalUpdateUI = window.updateUIAfterFormSubmission;

        // Override with our custom logic for power messages
        window.updateUIAfterFormSubmission = function (form, responseData) {
            const action = form.action;

            if (action.includes('/power-messages/add')) {
                // For add operations, we still need to reload to show the new message
                // since we'd need to dynamically create the card and modal
                form.reset();
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else if (action.includes('/power-messages/delete')) {
                const messageId = form.querySelector('input[name="message_id"]').value;
                removeMessageCard(messageId);
                // Close any open modals
                const modal = bootstrap.Modal.getInstance(document.querySelector(`#editMessageModal${messageId}`));
                if (modal) {
                    modal.hide();
                }
            } else if (action.includes('/power-messages/toggle')) {
                const messageId = form.querySelector('input[name="message_id"]').value;
                const isActive = responseData.is_active;
                updateMessageCard(messageId, isActive);
            } else if (action.includes('/power-messages/update')) {
                const messageId = form.querySelector('input[name="message_id"]').value;
                const newMessage = responseData.message || form.querySelector('textarea[name="message"]').value;
                updateMessageText(messageId, newMessage);
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.querySelector(`#editMessageModal${messageId}`));
                if (modal) {
                    modal.hide();
                }
            } else if (action.includes('/power-messages/activate-all')) {
                // Reload for bulk operations since it's more complex to update all cards
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                // Call the original function for non-power-message actions
                if (originalUpdateUI) {
                    originalUpdateUI(form, responseData);
                }
            }
        };
    });
</script>