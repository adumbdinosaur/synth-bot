{% extends "base.html" %}

{% block title %}Session Info - {{ session.display_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="fas fa-user-circle"></i> {{ session.display_name }}
                        {% if session.is_connected %}
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-circle"></i> Online
                        </span>
                        {% else %}
                        <span class="badge bg-secondary ms-2">
                            <i class="fas fa-circle"></i> Offline
                        </span>
                        {% endif %}
                    </h2>
                    <p class="text-muted mb-0">User ID: {{ session.user_id }}</p>
                </div>
                <div>
                    <a href="/public/sessions" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Success/Error Messages -->
            {% if request.query_params.get('success') %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> {{ request.query_params.get('success') }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i> {{ request.query_params.get('error') }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            <!-- Session Overview -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-battery-three-quarters fa-2x text-primary mb-2"></i>
                            <h3 class="mb-0">{{ session.energy }}/100</h3>
                            <small class="text-muted">Current Energy</small>
                            <div class="progress mt-2">
                                <div class="progress-bar 
                                        {% if session.energy > 70 %}bg-success
                                        {% elif session.energy > 30 %}bg-warning
                                        {% else %}bg-danger{% endif %}" role="progressbar"
                                    style="width: {{ session.energy }}%">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <i class="fas fa-bolt fa-2x text-info mb-2"></i>
                            <h3 class="mb-0">{{ session.energy_recharge_rate }}</h3>
                            <small class="text-muted">Energy/Minute</small>
                            <div class="mt-3">
                                <form method="POST" action="/public/sessions/{{ session.user_id }}/recharge-rate"
                                    class="d-inline">
                                    <div class="input-group input-group-sm">
                                        <input type="number" name="recharge_rate" class="form-control form-control-sm"
                                            value="{{ session.energy_recharge_rate }}" min="0" max="10" step="1"
                                            title="Energy recharged per minute (0-10)">
                                        <button type="submit" class="btn btn-info btn-sm">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                            <h5 class="mb-0">{{ session.account_created[:10] if session.account_created else 'Unknown'
                                }}</h5>
                            <small class="text-muted">Member Since</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Energy Recharge Rate Info -->
            <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <div>
                    <strong>Energy Recharge Rate:</strong>
                    You can adjust how fast this user's energy recharges by changing the rate above.
                    Set to 0 to disable automatic recharge, or up to 10 energy per minute for fast recharge.
                </div>
            </div>

            <!-- Profile Management Section -->
            {% if session.is_connected and current_profile %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-user-edit"></i> Profile Management</h4>
                            <p class="text-muted mb-0">Update profile information with no energy cost</p>
                        </div>
                        <div class="card-body">
                            <!-- Current vs Original Profile Info -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5><i class="fas fa-user"></i> Current Profile</h5>
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <p><strong>First Name:</strong> {{ current_profile.first_name or 'None' }}
                                            </p>
                                            <p><strong>Last Name:</strong> {{ current_profile.last_name or 'None' }}</p>
                                            <p><strong>Bio:</strong> {{ current_profile.bio or 'None' }}</p>
                                            <p><strong>Profile Photo:</strong>
                                                {% if current_profile.profile_photo_id %}
                                                <span class="badge bg-success">Set</span>
                                                {% else %}
                                                <span class="badge bg-secondary">None</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% if original_profile %}
                                <div class="col-md-6">
                                    <h5><i class="fas fa-history"></i> Saved State</h5>
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <p><strong>First Name:</strong> {{ original_profile.first_name or 'None' }}
                                            </p>
                                            <p><strong>Last Name:</strong> {{ original_profile.last_name or 'None' }}
                                            </p>
                                            <p><strong>Bio:</strong> {{ original_profile.bio or 'None' }}</p>
                                            <p><strong>Profile Photo:</strong>
                                                {% if original_profile.profile_photo_id %}
                                                <span class="badge bg-success">Set</span>
                                                {% else %}
                                                <span class="badge bg-secondary">None</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Profile Update Form -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5><i class="fas fa-edit"></i> Update Profile</h5>
                                    <form method="POST" action="/public/sessions/{{ session.user_id }}/profile/update">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="first_name" class="form-label">First Name</label>
                                                <input type="text" class="form-control" id="first_name"
                                                    name="first_name" value="{{ current_profile.first_name or '' }}"
                                                    maxlength="50">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="last_name" class="form-label">Last Name</label>
                                                <input type="text" class="form-control" id="last_name" name="last_name"
                                                    value="{{ current_profile.last_name or '' }}" maxlength="50">
                                            </div>
                                            <div class="col-12">
                                                <label for="bio" class="form-label">Bio</label>
                                                <textarea class="form-control" id="bio" name="bio" rows="3"
                                                    maxlength="70">{{ current_profile.bio or '' }}</textarea>
                                                <div class="form-text">Maximum 70 characters for Telegram bio</div>
                                            </div>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="alert alert-info mb-3">
                                                    <i class="fas fa-info-circle"></i>
                                                    <strong>Note:</strong> Updates will automatically save as the new
                                                    "original" profile state.
                                                </div>
                                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save"></i> Update & Save as New State (Free)
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Revert Cost Configuration -->
                            <div class="row">
                                <div class="col-12">
                                    <h5><i class="fas fa-undo"></i> Profile Revert Settings</h5>
                                    <form method="POST"
                                        action="/public/sessions/{{ session.user_id }}/profile/revert-cost">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-4">
                                                <label for="revert_cost" class="form-label">Energy Cost to Revert
                                                    Profile</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="revert_cost"
                                                        name="revert_cost" value="{{ profile_revert_cost }}" min="0"
                                                        max="100" required>
                                                    <span class="input-group-text">⚡</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <button type="submit" class="btn btn-secondary">
                                                    <i class="fas fa-save"></i> Update Cost
                                                </button>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted">
                                                    Cost for reverting profile back to saved state
                                                </small>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Profile Management Info -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> How Profile Management Works</h6>
                                        <ul class="mb-0">
                                            <li><strong>Update Profile:</strong> Change first name, last name, and bio
                                                with no energy cost</li>
                                            <li><strong>Automatic Save:</strong> Updates automatically become the new
                                                "original" state for future comparisons</li>
                                            <li><strong>Revert Cost:</strong> Configure energy cost for reverting back
                                                to saved state</li>
                                            <li><strong>No Photo Upload:</strong> Photo uploads not yet supported in
                                                this interface</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% elif session.is_connected %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Profile management is not available - Profile Manager not initialized for this user.
                    </div>
                </div>
            </div>
            {% else %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Profile management is only available when the user is connected to Telegram.
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Energy Cost Configuration -->
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-cogs"></i> Energy Cost Configuration</h4>
                    <p class="text-muted mb-0">Configure how much energy each message type costs for this user</p>
                </div>
                <div class="card-body">
                    <form method="POST" action="/public/sessions/{{ session.user_id }}/energy-costs">
                        <div class="row g-3">
                            {% for cost in energy_costs %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card border-light">
                                    <div class="card-body">
                                        <label for="{{ cost.message_type }}_cost" class="form-label">
                                            <i class="fas fa-{% if cost.message_type == 'text' %}font
                                                {% elif cost.message_type == 'photo' %}image
                                                {% elif cost.message_type == 'video' %}video
                                                {% elif cost.message_type == 'audio' %}music
                                                {% elif cost.message_type == 'voice' %}microphone
                                                {% elif cost.message_type == 'document' %}file
                                                {% elif cost.message_type == 'sticker' %}smile
                                                {% elif cost.message_type == 'animation' %}gif
                                                {% elif cost.message_type == 'gif' %}images
                                                {% elif cost.message_type == 'location' %}map-marker-alt
                                                {% elif cost.message_type == 'contact' %}address-book
                                                {% elif cost.message_type == 'poll' %}poll
                                                {% elif cost.message_type == 'game' %}gamepad
                                                {% elif cost.message_type == 'venue' %}map-marker
                                                {% elif cost.message_type == 'web_page' %}link
                                                {% elif cost.message_type == 'media_group' %}images
                                                {% else %}message{% endif %}"></i>
                                            {{ cost.message_type.replace('_', ' ').title() }}
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="{{ cost.message_type }}_cost"
                                                name="{{ cost.message_type }}_cost" value="{{ cost.energy_cost }}"
                                                min="0" max="100" required>
                                            <span class="input-group-text">⚡</span>
                                        </div>
                                        {% if cost.description %}
                                        <small class="text-muted">{{ cost.description }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="button" class="btn btn-outline-secondary me-md-2"
                                        onclick="resetDefaults()">
                                        <i class="fas fa-undo"></i> Reset to Defaults
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Energy Costs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Badwords Management Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-ban"></i> Badwords Management</h4>
                            <p class="text-muted mb-0">Manage words that trigger automatic filtering and energy
                                penalties
                            </p>
                        </div>
                        <div class="card-body">
                            <!-- Add New Badword Form -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5><i class="fas fa-plus"></i> Add New Badword</h5>
                                    <form method="POST" action="/public/sessions/{{ session.user_id }}/badwords/add">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label for="word" class="form-label">Word</label>
                                                <input type="text" class="form-control" id="word" name="word"
                                                    placeholder="Enter badword" required maxlength="50">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="penalty" class="form-label">Energy Penalty</label>
                                                <input type="number" class="form-control" id="penalty" name="penalty"
                                                    value="5" min="1" max="100" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Options</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="case_sensitive"
                                                        name="case_sensitive" value="true">
                                                    <label class="form-check-label" for="case_sensitive">
                                                        Case Sensitive
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="submit" class="btn btn-danger w-100">
                                                    <i class="fas fa-plus"></i> Add
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Current Badwords List -->
                            <div class="row">
                                <div class="col-12">
                                    <h5><i class="fas fa-list"></i> Current Badwords ({{ badwords|length }})</h5>
                                    {% if badwords %}
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Word</th>
                                                    <th>Energy Penalty</th>
                                                    <th>Case Sensitive</th>
                                                    <th>Added</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for badword in badwords %}
                                                <tr>
                                                    <td>
                                                        <code class="text-danger">{{ badword.word }}</code>
                                                    </td>
                                                    <td>
                                                        <form method="POST"
                                                            action="/public/sessions/{{ session.user_id }}/badwords/update"
                                                            class="d-inline">
                                                            <input type="hidden" name="word" value="{{ badword.word }}">
                                                            <div class="input-group input-group-sm"
                                                                style="width: 120px;">
                                                                <input type="number" class="form-control" name="penalty"
                                                                    value="{{ badword.penalty }}" min="1" max="100"
                                                                    required>
                                                                <button type="submit"
                                                                    class="btn btn-outline-primary btn-sm">
                                                                    <i class="fas fa-save"></i>
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </td>
                                                    <td>
                                                        {% if badword.case_sensitive %}
                                                        <span class="badge bg-warning">
                                                            <i class="fas fa-check"></i> Yes
                                                        </span>
                                                        {% else %}
                                                        <span class="badge bg-secondary">
                                                            <i class="fas fa-times"></i> No
                                                        </span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">
                                                            {{ badword.created_at[:10] if badword.created_at else
                                                            'Unknown' }}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <form method="POST"
                                                            action="/public/sessions/{{ session.user_id }}/badwords/remove"
                                                            class="d-inline">
                                                            <input type="hidden" name="word" value="{{ badword.word }}">
                                                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                                                onclick="return confirm('Remove badword \'{{ badword.word }}\'?')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No badwords configured for this user. Add some above to enable message
                                        filtering.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Badwords Info -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle"></i> How Badwords Work</h6>
                                        <ul class="mb-0">
                                            <li><strong>Detection:</strong> Messages containing badwords are
                                                automatically detected
                                            </li>
                                            <li><strong>Filtering:</strong> Badwords are replaced with
                                                <code>&lt;redacted&gt;</code> in the message
                                            </li>
                                            <li><strong>Energy Penalty:</strong> User loses energy equal to the penalty
                                                for each badword used
                                            </li>
                                            <li><strong>Case Sensitivity:</strong> Choose whether matching should be
                                                case-sensitive or not
                                            </li>
                                            <li><strong>Multiple Words:</strong> If a message contains multiple
                                                badwords, all penalties are combined
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Information Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-info-circle"></i> About Energy Costs</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-lightbulb"></i> How Energy Works</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check text-success"></i> Each message type consumes energy
                                            when sent</li>
                                        <li><i class="fas fa-check text-success"></i> Energy recharges automatically
                                            over time</li>
                                        <li><i class="fas fa-check text-success"></i> Users need sufficient energy to
                                            send messages</li>
                                        <li><i class="fas fa-check text-success"></i> Higher costs mean fewer messages
                                            of that type</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-cog"></i> Configuration Tips</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-lightbulb text-warning"></i> Set higher costs for
                                            media-heavy messages</li>
                                        <li><i class="fas fa-lightbulb text-warning"></i> Text messages typically cost
                                            less energy</li>
                                        <li><i class="fas fa-lightbulb text-warning"></i> Consider user behavior when
                                            setting costs</li>
                                        <li><i class="fas fa-lightbulb text-warning"></i> Monitor energy levels to
                                            adjust accordingly</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function resetDefaults() {
        // Default energy costs based on message type
        const defaults = {
            'text_cost': 1,
            'photo_cost': 3,
            'video_cost': 5,
            'audio_cost': 4,
            'voice_cost': 2,
            'document_cost': 3,
            'sticker_cost': 1,
            'animation_cost': 3,
            'gif_cost': 4,
            'location_cost': 2,
            'contact_cost': 2,
            'poll_cost': 3,
            'game_cost': 3,
            'venue_cost': 2,
            'web_page_cost': 2,
            'media_group_cost': 5
        };

        if (confirm('Are you sure you want to reset all energy costs to default values?')) {
            Object.keys(defaults).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    input.value = defaults[key];
                }
            });
        }
    }

    // Auto-dismiss alerts after 5 seconds
    setTimeout(function () {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.classList.contains('show')) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        });
    }, 5000);
</script>
{% endblock %}